# مراجعة نظام إدارة الأعلاف — التحليل الشامل

**التاريخ:** 2026-02-25  
**الملفات المراجعة:** 12 ملف (Schema + 8 API Routes + UI + Prisma Client + Auth)  
**إجمالي المشاكل المكتشفة:** 38 مشكلة

---

## ١. ملخص تنفيذي

نظام إدارة الأعلاف يحتوي على بنية جيدة بشكل عام مع عزل المستأجرين (tenant isolation) عبر Prisma middleware، وتسجيل الأنشطة، والتحقق من الصلاحيات. لكن هناك **مشاكل حرجة** في حالة السباق (race condition) بعملية صرف الأعلاف، وثغرات في التحقق من المدخلات في عدة نقاط، وأخطاء حسابية في واجهة المستخدم (قسمة على صفر)، بالإضافة لعدم اتساق في حساب التكاليف.

---

## ٢. المشاكل الحرجة (CRITICAL)

| ID | الوصف | الملف | السطر | التأثير |
|----|-------|-------|-------|---------|
| **CR-01** | **حالة سباق (Race Condition) في صرف الأعلاف:** التحقق من عدم تنفيذ الصرف مسبقاً يتم عبر `ActivityLog.findMany` (TOCTOU). طلبان متزامنان لنفس التاريخ سيجدان كلاهما أنه لم يُنفذ، فيُخصمان المخزون مرتين. المخزون يُقرأ *قبل* المعاملة (transaction) ويُحسب `nextQty` من القيمة القديمة، فإذا نجح طلب A ثم نجح طلب B يُعاد تعيين الكمية للقيمة الخاطئة (مثلاً: 100→90 بدلاً من 100→90→80). | `src/app/api/feeds/consume/route.ts` | L120-140, L235 | خصم مزدوج من المخزون — فقدان بيانات مالية |
| **CR-02** | **انتهاك قيد الفريدة (Unique Constraint) في DailyFeedConsumption:** إذا وُجد جدولان تغذية نشطان لنفس `penId` و `feedTypeId` (ككميات مختلفة)، يحاول الكود أثناء `$transaction` إنشاء سجلين بنفس `[tenantId, date, feedTypeId, penId]` مما يُسبب خطأ Prisma ويؤدي لتراجع كامل المعاملة وفشل الصرف. | `src/app/api/feeds/consume/route.ts` | L247-262 + `schema.prisma` L775 | تعطل كامل عملية الصرف اليومي |
| **CR-03** | **القيد الفريد لـ DailyFeedConsumption مع NULL:** القيد `@@unique([tenantId, date, feedTypeId, penId])` يحتوي على `penId` الذي يمكن أن يكون `null`. في MySQL، `NULL ≠ NULL` في القيود الفريدة، مما يعني أن سجلات متعددة بـ `penId = null` لنفس التاريخ ونوع العلف ستُقبل بدون خطأ — تكرار بيانات الاستهلاك. | `prisma/schema.prisma` | L775 | بيانات استهلاك مكررة بدون اكتشاف |
| **CR-04** | **خصم المخزون في FeedingRecord بدون Transaction:** عند إنشاء سجل تغذية، يُنشأ السجل أولاً ثم يُخصم المخزون بدون `$transaction`. إذا فشل الخصم جزئياً (بعد تحديث بعض الأسطر)، ستكون البيانات غير متسقة. | `src/app/api/feeding-records/route.ts` | L85-100 | تناقض بين السجلات والمخزون الفعلي |

---

## ٣. المشاكل المهمة (HIGH)

| ID | الوصف | الملف | السطر | التأثير |
|----|-------|-------|-------|---------|
| **HI-01** | **قسمة على صفر في حساب أيام المخزون المتبقية:** عند وجود حظيرة بـ 0 رؤوس (heads=0)، يصبح `totalForItem = item.amount * 0 = 0` ثم `stockQty / 0 = Infinity`. جزء `daysRemaining` يصبح `Math.floor(Infinity)` = Infinity. الـ Tooltip يعرض "يكفي المخزون لـ Infinity يوم". | `src/app/dashboard/feeds/page.tsx` | L826-827 | عرض بيانات خاطئة للمستخدم |
| **HI-02** | **عدم التحقق من المدخلات في تحديث المخزون (PUT):** نقطة `stock/[id]` PUT لا تتحقق من أي مدخلات — الكمية يمكن أن تكون سالبة، و`feedTypeId` يمكن أن يكون لا يخص المزرعة الحالية، والسعر يمكن أن يكون سالباً. | `src/app/api/feeds/stock/[id]/route.ts` | L20-34 | إدخال بيانات فاسدة في قاعدة البيانات |
| **HI-03** | **عدم التحقق من المدخلات في تحديث نوع العلف (PUT):** نقطة `feeds/[id]` PUT لا تتحقق من أن `nameAr` غير فارغ أو أن `category` صالح. يمكن تمرير فئة غير معروفة أو اسم فارغ. | `src/app/api/feeds/[id]/route.ts` | L23-44 | بيانات أنواع أعلاف تالفة |
| **HI-04** | **حذف نوع العلف لا يتحقق من FeedingRecord:** الحذف يتحقق فقط من `FeedStock` و `FeedingSchedule`، لكن لا يتحقق من `FeedingRecord` المرتبطة. بسبب `onDelete: SetNull` في FeedingRecord لن يحدث خطأ قاعدة بيانات، لكن سيُفقد ارتباط السجلات التاريخية بنوع العلف. | `src/app/api/feeds/[id]/route.ts` | L86-98 | فقدان ربط السجلات التاريخية |
| **HI-05** | **حساب تكلفة اليوم يستخدم أول مخزون فقط:** `dailyCost` و `todayFeedings` يستخدمان `stocks.find()` الذي يُرجع أول سجل مخزون فقط لنوع العلف. إذا وُجدت دفعات مخزون بأسعار مختلفة، تُحسب التكلفة من سعر دفعة واحدة فقط بدلاً من المتوسط المرجح. | `src/app/dashboard/feeds/page.tsx` | L327-333, L311-316 | حساب تكلفة يومية غير دقيق |
| **HI-06** | **الصرف التلقائي عند فتح الصفحة:** `runAutoConsume()` يُنفذ تلقائياً عند تحميل صفحة الأعلاف. إذا فتح المستخدم عدة تبويبات، ستُرسل طلبات صرف متعددة متزامنة (يُفاقم CR-01). بالإضافة، عملية قد تخصم من المخزون بدون إذن صريح من المستخدم. | `src/app/dashboard/feeds/page.tsx` | L249-253 | صرف غير متوقع + تفاقم حالة السباق |
| **HI-07** | **حذف جميع الجداول عبر DELETE على المجموعة:** نقطة `schedule/route.ts` DELETE تحذف *جميع* الجداول (`deleteMany({})`). رغم أن Prisma middleware يُضيف `tenantId/farmId`، هذه عملية خطيرة (mass delete) يجب أن تكون لها حماية إضافية أو تسجيل مُسبق واضح. | `src/app/api/feeds/schedule/route.ts` | L108-120 | حذف جميع جداول التغذية بطريق الخطأ |
| **HI-08** | **الجداول الشهرية الذكية تحذف جميع الجداول الموجودة:** `schedule/monthly` POST يستخدم `deleteMany({})` ثم يُنشئ جداول جديدة. لا يوجد خيار "إلحاق" بدلاً من "استبدال"، وإذا فشل الإنشاء بعد الحذف تُفقد جميع الجداول. لا يوجد `$transaction` يغطي العملية بالكامل. | `src/app/api/feeds/schedule/monthly/route.ts` | L100-106 | فقدان جداول التغذية بدون إنشاء بدائل |

---

## ٤. المشاكل المتوسطة (MEDIUM)

| ID | الوصف | الملف | السطر | التأثير |
|----|-------|-------|-------|---------|
| **MD-01** | **قيمة `reorderLevel` عند إدخال 0:** في POST لأنواع الأعلاف، `body.reorderLevel ? parseFloat(...) : 50` — إذا أدخل المستخدم 0 (قيمة falsy)، يُستبدل بـ 50 بدلاً من الحفاظ على القيمة 0. | `src/app/api/feeds/route.ts` | L78 | لا يمكن تعيين حد إعادة الطلب إلى 0 |
| **MD-02** | **نطاق شريط التقدم (Progress Bar) عشوائي:** النسبة تُحسب كـ `totalQty / (reorderLevel * 4) * 100`. المضاعف ×4 عشوائي وغير موثق، فالشريط يمتلئ عند 4 أضعاف حد الطلب. المستخدم لا يفهم ماذا يمثل 100%. | `src/app/dashboard/feeds/page.tsx` | L934 | شريط تقدم مضلل للمستخدم |
| **MD-03** | **لا توجد صفحات (Pagination) في GET المخزون:** `feeds/stock` GET يعيد جميع سجلات المخزون بدون حد أو ترقيم. مع تزايد البيانات، الأداء سيتدهور. | `src/app/api/feeds/stock/route.ts` | L14-22 | بطء الأداء مع كبر البيانات |
| **MD-04** | **لا توجد صفحات في GET سجلات التغذية:** `feeding-records` GET يعيد جميع السجلات بدون ترقيم. | `src/app/api/feeding-records/route.ts` | L14-42 | بطء الأداء |
| **MD-05** | **لا توجد صفحات في GET الأعلاف:** `feeds` GET يُحمّل جميع أنواع الأعلاف مع المخزون والجداول (`include: stock, schedules`). الجلب يتضمن بيانات متداخلة عميقة. | `src/app/api/feeds/route.ts` | L14-34 | تحميل بيانات زائد |
| **MD-06** | **حذف المخزون لا يحذف سجل المصروف المُنشأ تلقائياً:** عند إنشاء مخزون، يُنشأ سجل مصروف تلقائياً. لكن حذف المخزون لا يحذف سجل المصروف المرتبط — لا يوجد رابط (FK) بينهما. | `src/app/api/feeds/stock/route.ts` (POST L70-84) + `stock/[id]/route.ts` (DELETE) | — | مصاريف يتيمة في قاعدة البيانات |
| **MD-07** | **اقتراح الكمية الذكي لا يعمل بشكل صحيح:** `computeSuggestion` يبحث عن `pen?.goats` لكن API الحظائر (`/api/pens`) قد لا يُرجع بيانات الماعز (goats) مع كل تفاصيلها (gender, birthDate, weight). نوع `Pen` يُعرّف `goats?: any[]` كحقل اختياري. | `src/app/dashboard/feeds/page.tsx` | L478-483 | الاقتراح الذكي قد لا يظهر أبداً |
| **MD-08** | **`toggleScheduleActive` بدون رسالة نجاح/خطأ:** عند تبديل حالة الجدول (نشط/متوقف)، لا تُعرض أي رسالة للمستخدم سواء نجح أو فشل. | `src/app/dashboard/feeds/page.tsx` | L521-527 | لا تغذية راجعة للمستخدم |
| **MD-09** | **`fetchAll` يلتقط الأخطاء بصمت:** كتلة `catch` فارغة بتعليق `/* silent */`. إذا فشل جلب البيانات، لا يظهر أي خطأ للمستخدم. | `src/app/dashboard/feeds/page.tsx` | L282 | المستخدم لا يعرف سبب عدم ظهور البيانات |
| **MD-10** | **لا يوجد تأكيد قبل تنفيذ صرف اليوم:** زر "تنفيذ صرف اليوم" يخصم من المخزون مباشرة بدون نافذة تأكيد. العملية غير قابلة للتراجع. | `src/app/dashboard/feeds/page.tsx` | L538-575 | خصم غير مقصود من المخزون |
| **MD-11** | **`protein` و `energy` عند القيمة 0:** في POST و PUT لأنواع الأعلاف، `body.protein ? parseFloat(...) : null` — إذا أدخل المستخدم 0 (قيمة falsy)، تُحفظ كـ `null` بدلاً من 0. | `src/app/api/feeds/route.ts` L74-75 + `feeds/[id]/route.ts` L37-38 | القيم الصفرية لا يمكن حفظها |
| **MD-12** | **عدم التحقق من وجود السجل قبل تحديثه:** `feeds/[id]` PUT و `stock/[id]` PUT لا يتحققان من وجود السجل قبل محاولة التحديث. `prisma.update` سيُلقي خطأ Prisma غير ودي بدلاً من رسالة 404 واضحة. | `src/app/api/feeds/[id]/route.ts` L47 + `stock/[id]/route.ts` L37 | رسالة خطأ غير مفهومة للمستخدم |
| **MD-13** | **FeedingSchedule حذف فردي لا يتحقق من الوجود:** `schedule/[id]` DELETE يحذف مباشرة بدون `findUnique` أولاً. إذا لم يكن الجدول موجوداً، يُلقى خطأ Prisma. | `src/app/api/feeds/schedule/[id]/route.ts` | L62-75 | رسالة خطأ 500 بدلاً من 404 |

---

## ٥. المشاكل المنخفضة (LOW)

| ID | الوصف | الملف | السطر | التأثير |
|----|-------|-------|-------|---------|
| **LO-01** | **مكون `KpiCard` مُعرّف لكن غير مستخدم:** المكون مُعرّف في نهاية الملف (سطر 1413) لكن لا يُستدعى في أي مكان. | `src/app/dashboard/feeds/page.tsx` | L1413-1426 | كود ميت |
| **LO-02** | **عدم تسجيل تفاصيل الخطأ في كتل catch:** معظم نقاط API تلتقط الأخطاء لكن لا تُسجلها بـ `console.error` (ما عدا `consume` و `feeding-records`). | `src/app/api/feeds/route.ts`, `feeds/[id]/route.ts`, `stock/route.ts`, `stock/[id]/route.ts`, `schedule/route.ts`, `schedule/[id]/route.ts` | كتل catch | صعوبة تتبع الأخطاء في الإنتاج |
| **LO-03** | **نوع `any` مستخدم بكثرة:** `createData: any`، `updateData: any`، `where: any` — يُضعف أمان النوع (type safety) في TypeScript. | عدة ملفات API | — | ضعف أمان النوع |
| **LO-04** | **عنصر `isTabletOrBelow` مُعرّف لكن غير مستخدم:** | `src/app/dashboard/feeds/page.tsx` | L205 | متغير غير مستخدم |
| **LO-05** | **فلتر `isActive` في GET الجداول:** `isActive !== null` يتحقق بشكل صحيح، لكن إذا مرر المستخدم `?isActive=anythingelse` ستُرجع الجداول حيث `isActive = false` فقط لأن `'anythingelse' === 'true'` هي false. | `src/app/api/feeds/schedule/route.ts` | L22-23 | فلترة غير متوقعة |
| **LO-06** | **حقل `feedType` (String) في FeedingRecord مكرر مع `feedTypeRef`:** النموذج يحتوي على `feedType` كنص حر و `feedTypeId` كمرجع. هذا تكرار للبيانات (denormalization) يمكن أن يؤدي لعدم اتساق. | `prisma/schema.prisma` | L477-479 | ازدواجية بيانات |
| **LO-07** | **الجداول الشهرية الذكية تستخدم تاريخ انتهاء ثابت 30 يوماً:** بدلاً من حسابه ديناميكياً بناءً على نهاية الشهر. | `src/app/api/feeds/schedule/monthly/route.ts` | L118-119 | جداول لا تتطابق مع حدود الأشهر الفعلية |
| **LO-08** | **`supplier` مكرر في FeedType و FeedStock:** المورد يُخزّن في كلا الجدولين بشكل مستقل. | `prisma/schema.prisma` | L694, L724 | ازدواجية بيانات طفيفة |
| **LO-09** | **استيراد `Divider` و `Fade` و `Skeleton` وأيقونات غير مستخدمة بالكامل:** بعض الاستيرادات قد لا تُستخدم كلها. | `src/app/dashboard/feeds/page.tsx` | L1-28 | حجم حزمة أكبر قليلاً |

---

## ٦. ميزات مفقودة أو ناقصة

| # | الميزة | الأهمية | التفاصيل |
|---|--------|---------|----------|
| 1 | **تراجع عن صرف الأعلاف (Undo Consumption)** | عالية | لا توجد طريقة لإلغاء صرف يومي خاطئ — المخزون يُخصم بلا رجعة |
| 2 | **تقرير الاستهلاك التاريخي في UI** | عالية | لا يوجد عرض لسجلات `DailyFeedConsumption` السابقة في واجهة الأعلاف |
| 3 | **تنبيهات المخزون عبر Push/Email** | متوسطة | التنبيهات تظهر فقط عند فتح صفحة الأعلاف — لا إشعارات proactive |
| 4 | **حماية التزامن (Optimistic Locking)** | عالية | لا يوجد حقل `version` أو `updatedAt` check لمنع الكتابة فوق تعديلات أخرى |
| 5 | **فلترة المخزون بالفئة/الحالة** | منخفضة | صفحة المخزون لا توفر فلاتر بالفئة أو الحالة (منتهي/منخفض) |
| 6 | **تصدير PDF للجداول** | منخفضة | التصدير يشمل المخزون فقط — لا يشمل جداول التغذية |
| 7 | **Soft Delete للأنواع** | متوسطة | حذف نوع علف نهائي — لا يوجد أرشفة |
| 8 | **تتبع تاريخ التغييرات على الجداول** | متوسطة | لا يوجد Audit Trail لتعديلات الجداول — فقط ActivityLog عام |
| 9 | **واجهة ربط FeedingRecord بنوع محدد** | متوسطة | `FeedingRecord` يدعم `feedTypeId` لكن لا توجد واجهة في صفحة الأعلاف لعرض/إدارة سجلات التغذية |
| 10 | **Batch Import للمخزون** | منخفضة | لا يوجد استيراد مجمّع من Excel/CSV |

---

## ٧. نقاط القوة

| # | النقطة | التفاصيل |
|---|--------|----------|
| 1 | **عزل المستأجرين (Tenant Isolation)** | Prisma middleware متين يُضيف `tenantId` و `farmId` تلقائياً لجميع العمليات (CRUD). يشمل `findUnique → findFirst` conversion. تغطية شاملة. |
| 2 | **نظام صلاحيات دقيق** | `requirePermission` مع فصل بين `view_feeds`، `add_feed`، `manage_feeds`. تجاوز للأدوار العليا (SUPER_ADMIN/OWNER/ADMIN). |
| 3 | **تسجيل الأنشطة (Activity Logging)** | جميع عمليات CRUD تُسجل في `ActivityLog` مع userId, IP, UserAgent. |
| 4 | **تطبيع الفئات (Category Normalization)** | معالجة `GRAIN→GRAINS` و `SUPPLEMENT→SUPPLEMENTS` في الإنشاء والتحديث. |
| 5 | **نظام الاقتراح الذكي** | `suggestFeedAmount` يحسب كميات التغذية بناءً على العمر والوزن وجنس الحيوان ونوع المزرعة (أغنام/إبل). |
| 6 | **إنشاء المصاريف التلقائي** | إضافة مخزون تُنشئ تلقائياً سجل مصروف في فئة FEED. |
| 7 | **FIFO في الصرف** | خصم المخزون يتبع ترتيب `purchaseDate ASC` (الأقدم أولاً) — صحيح محاسبياً. |
| 8 | **حماية الصرف من الحذف المُسبق** | `consume` يتحقق من ActivityLog markers قبل التنفيذ لمنع التكرار (رغم عدم كفايته بسبب CR-01). |
| 9 | **واجهة متجاوبة** | تصميم responsive مع عروض مختلفة للجوال والكمبيوتر (Cards vs DataGrid). |
| 10 | **حد 90 يوم للصرف التلقائي** | `PERF-03` يمنع معالجة سنوات من البيانات عند الصرف التلقائي. |

---

## ٨. توصيات الأولوية

### الأولوية ١ — حرج (يجب إصلاحه فوراً)

1. **إصلاح Race Condition في الصرف (CR-01):**
   - استخدام `SELECT ... FOR UPDATE` أو قفل صف في جدول مخصص (مثلاً `FeedConsumptionLock` بقيد فريد على `[tenantId, farmId, date]`)
   - نقل قراءة المخزون إلى داخل `$transaction` مع `{ isolationLevel: 'Serializable' }`
   - أو استخدام Redis distributed lock إذا كانت البيئة تدعم ذلك

2. **إصلاح تكرار DailyFeedConsumption لنفس الحظيرة (CR-02):**
   - في `consume/route.ts` L247-262، تجميع الجداول بـ `penId` قبل الإنشاء، واستخدام `upsert` بدلاً من `create`
   
3. **إصلاح NULL في القيد الفريد (CR-03):**
   - تغيير `penId` إلى قيمة افتراضية (مثلاً `'__none__'`) بدلاً من null، أو إنشاء قيد مركب مختلف

4. **لف خصم المخزون في FeedingRecord بـ $transaction (CR-04):**
   ```typescript
   await prisma.$transaction(async (tx) => {
     const record = await tx.feedingRecord.create({...})
     // خصم المخزون هنا داخل tx
   })
   ```

### الأولوية ٢ — مهم (خلال أسبوع)

5. **إضافة تحقق المدخلات لـ stock/[id] PUT و feeds/[id] PUT (HI-02, HI-03)**
6. **إصلاح قسمة على صفر في الواجهة (HI-01):** إضافة `if (totalForItem === 0) return 0` أو `|| 1`
7. **تصحيح حساب التكلفة اليومية (HI-05):** استخدام متوسط سعر مرجح عبر جميع دفعات المخزون
8. **إلغاء الصرف التلقائي عند فتح الصفحة (HI-06):** أو على الأقل إضافة throttle/debounce
9. **لف عمليات الجداول الشهرية الذكية في $transaction (HI-08)**
10. **إضافة تأكيد قبل صرف اليوم (MD-10)**

### الأولوية ٣ — متوسط (خلال شهر)

11. **إضافة Pagination لجميع نقاط GET (MD-03, MD-04, MD-05)**
12. **إصلاح القيم الصفرية الكاذبة (MD-01, MD-11):** استبدال `?` بـ `!== undefined && !== null`
13. **إضافة رسائل نجاح/خطأ لـ toggleScheduleActive (MD-08)**
14. **إظهار خطأ عند فشل fetchAll (MD-09)**
15. **التحقق من وجود السجل قبل التحديث (MD-12, MD-13)**
16. **إضافة console.error في جميع كتل catch (LO-02)**
17. **حذف الكود الميت: KpiCard, isTabletOrBelow (LO-01, LO-04)**

### الأولوية ٤ — تحسينات مستقبلية

18. **إضافة ميزة تراجع عن الصرف (Undo)**
19. **إضافة عرض تاريخ الاستهلاك في الواجهة**
20. **إضافة Optimistic Locking**
21. **استبدال `any` بأنواع TypeScript دقيقة (LO-03)**
22. **توحيد حقل المورد بين FeedType و FeedStock (LO-08)**

---

> **ملاحظة:** عزل المستأجرين يعمل بشكل جيد عبر Prisma middleware في `src/lib/prisma.ts` (سطور 35-140). جميع عمليات القراءة والكتابة والتحديث والحذف تُفلتر تلقائياً بـ `tenantId` و `farmId`. هذا يُغطي الخطر الأمني الأساسي. المشاكل الحرجة المذكورة أعلاه تتعلق بسلامة البيانات وليس اختراق الحدود بين المستأجرين.
