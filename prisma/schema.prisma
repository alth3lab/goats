generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id          String     @id @default(uuid())
  username    String     @unique
  email       String     @unique
  password    String     // hashed password
  fullName    String
  phone       String?
  role        UserRole   @default(USER)
  isActive    Boolean    @default(true)
  lastLogin   DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  permissions UserPermission[]
  activities  ActivityLog[]

  @@index([username])
  @@index([email])
  @@index([role])
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique      // view_goats, add_goat, edit_goat, delete_goat, etc.
  nameAr      String                // عرض الماعز، إضافة ماعز، تعديل ماعز، حذف ماعز
  category    String                // goats, health, breeding, sales, users, reports
  categoryAr  String                // الماعز، الصحة، التكاثر، المبيعات، المستخدمين، التقارير
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       UserPermission[]

  @@index([category])
}

model UserPermission {
  id           String     @id @default(uuid())
  userId       String
  permissionId String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  grantedAt    DateTime   @default(now())
  grantedBy    String?    // userId who granted this permission

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

model ActivityLog {
  id          String       @id @default(uuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  action      String       // CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT
  entity      String       // Goat, Health, Breeding, etc.
  entityId    String?
  description String       @db.Text
  ipAddress   String?
  userAgent   String?      @db.Text
  createdAt   DateTime     @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}

model GoatType {
  id          String   @id @default(uuid())
  name        String   @unique  // SHEEP, GOAT
  nameAr      String             // خروف، ماعز
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  breeds      Breed[]

  @@index([name])
}

model Breed {
  id          String   @id @default(uuid())
  typeId      String
  type        GoatType @relation(fields: [typeId], references: [id], onDelete: Cascade)
  name        String   // Damascus, Nubian, Aradi, etc.
  nameAr      String   // شامي، نوبي، عارضي، نجدي، إلخ
  description String?  @db.Text
  avgWeight   Float?   // متوسط الوزن
  avgHeight   Float?   // متوسط الطول
  characteristics String? @db.Text  // الخصائص
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  goats       Goat[]

  @@unique([typeId, name])
  @@index([typeId])
}

model Pen {
  id          String   @id @default(uuid())
  name        String   @unique // Internal name or English
  nameAr      String          // Display name (Arabic)
  capacity    Int?            // Max number of heads
  type        String?         // ISOLATION, BREEDING, FATTENING, GENERAL
  notes       String?   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  goats             Goat[]
  feedingSchedules  FeedingSchedule[]
  feedConsumptions  DailyFeedConsumption[]
}

model Goat {
  id            String   @id @default(uuid())
  tagId         String   @unique
  name          String?
  breedId       String
  breed         Breed    @relation(fields: [breedId], references: [id])
  gender        Gender
  birthDate     DateTime
  weight        Float?
  color         String?
  status        GoatStatus @default(ACTIVE)
  motherId      String?
  fatherId      String?
  motherTagId   String?
  fatherTagId   String?
  birthId       String?
  penId         String?
  purchaseDate  DateTime?
  purchasePrice Float?
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  pen           Pen?      @relation(fields: [penId], references: [id], onDelete: SetNull)
  mother        Goat?     @relation("GoatMother", fields: [motherId], references: [id], onDelete: SetNull)
  father        Goat?     @relation("GoatFather", fields: [fatherId], references: [id], onDelete: SetNull)
  kidsAsMother  Goat[]    @relation("GoatMother")
  kidsAsFather  Goat[]    @relation("GoatFather")
  // birthId is stored for sibling grouping but without a Prisma relation
  kidBirths    Birth[]   @relation("KidGoat")

  healthRecords    HealthRecord[]
  breedingAsMother Breeding[]     @relation("MotherGoat")
  breedingAsFather Breeding[]     @relation("FatherGoat")
  feedingRecords   FeedingRecord[]
  sales            Sale[]

  @@index([tagId])
  @@index([breedId])
  @@index([status])
  @@index([motherId])
  @@index([fatherId])
  @@index([birthId])
}

model HealthRecord {
  id          String       @id @default(uuid())
  goatId      String
  goat        Goat         @relation(fields: [goatId], references: [id], onDelete: Cascade)
  type        HealthType
  date        DateTime
  description String       @db.Text
  veterinarian String?
  medication  String?
  dosage      String?
  cost        Float?
  nextDueDate DateTime?
  notes       String?      @db.Text
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([goatId])
  @@index([type])
  @@index([date])
}

model Breeding {
  id              String         @id @default(uuid())
  motherId        String
  fatherId        String
  mother          Goat           @relation("MotherGoat", fields: [motherId], references: [id])
  father          Goat           @relation("FatherGoat", fields: [fatherId], references: [id])
  matingDate      DateTime
  pregnancyStatus PregnancyStatus @default(MATED)
  dueDate         DateTime?
  birthDate       DateTime?
  numberOfKids    Int?
  notes           String?        @db.Text
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  births          Birth[]

  @@index([motherId])
  @@index([fatherId])
  @@index([matingDate])
}

model Birth {
  id          String   @id @default(uuid())
  breedingId  String
  breeding    Breeding @relation(fields: [breedingId], references: [id], onDelete: Cascade)
  kidTagId    String
  kidGoatId   String?
  kidGoat     Goat?     @relation("KidGoat", fields: [kidGoatId], references: [id], onDelete: SetNull)
  gender      Gender
  weight      Float?
  status      BirthStatus
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([breedingId])
  @@index([kidTagId])
  @@index([kidGoatId])
}

model FeedingRecord {
  id          String      @id @default(uuid())
  goatId      String?
  goat        Goat?       @relation(fields: [goatId], references: [id], onDelete: SetNull)
  date        DateTime
  feedType    String
  quantity    Float
  unit        String
  cost        Float?
  notes       String?     @db.Text
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([goatId])
  @@index([date])
}

model Sale {
  id          String   @id @default(uuid())
  goatId      String?
  goat        Goat?    @relation(fields: [goatId], references: [id], onDelete: SetNull)
  date        DateTime
  buyerName   String
  buyerPhone  String?
  salePrice   Float
  paymentStatus PaymentStatus @default(PENDING)
  notes       String?  @db.Text
  payments    Payment[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([goatId])
  @@index([date])
}

model Payment {
  id            String   @id @default(uuid())
  saleId        String
  sale          Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  amount        Float
  paymentDate   DateTime
  paymentMethod PaymentMethod @default(CASH)
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([saleId])
  @@index([paymentDate])
}

model Expense {
  id          String       @id @default(uuid())
  date        DateTime
  category    ExpenseCategory
  description String
  amount      Float
  paymentMethod String?
  notes       String?      @db.Text
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([date])
  @@index([category])
}

enum Gender {
  MALE
  FEMALE
}

enum GoatStatus {
  ACTIVE
  SOLD
  DECEASED
  QUARANTINE
}

enum HealthType {
  VACCINATION
  DEWORMING
  TREATMENT
  CHECKUP
  SURGERY
}

enum PregnancyStatus {
  MATED
  PREGNANT
  DELIVERED
  FAILED
}

enum BirthStatus {
  ALIVE
  STILLBORN
  DIED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
}

enum PaymentMethod {
  CASH
  TRANSFER
  CHECK
  OTHER
}

enum ExpenseCategory {
  FEED
  MEDICINE
  VETERINARY
  EQUIPMENT
  LABOR
  UTILITIES
  MAINTENANCE
  OTHER
}

enum UserRole {
  ADMIN        // مدير النظام - كل الصلاحيات
  MANAGER      // مدير المزرعة - معظم الصلاحيات
  VETERINARIAN // بيطري - صلاحيات السجلات الصحية
  USER         // مستخدم عادي - صلاحيات محدودة
  VIEWER       // عارض فقط - قراءة فقط
}

model InventoryItem {
  id            String               @id @default(uuid())
  name          String
  nameAr        String
  category      InventoryCategory
  unit          String               // كجم، لتر، قطعة، إلخ
  minStock      Float?               // الحد الأدنى للمخزون
  currentStock  Float                @default(0)
  unitPrice     Float?
  supplier      String?
  notes         String?              @db.Text
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  transactions  InventoryTransaction[]

  @@index([category])
  @@index([currentStock])
}

model InventoryTransaction {
  id          String             @id @default(uuid())
  itemId      String
  item        InventoryItem      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  type        TransactionType
  quantity    Float
  unitPrice   Float?
  totalCost   Float?
  reference   String?            // رقم الفاتورة أو المرجع
  notes       String?            @db.Text
  date        DateTime           @default(now())
  createdBy   String?
  createdAt   DateTime           @default(now())

  @@index([itemId])
  @@index([type])
  @@index([date])
}

model FeedType {
  id            String      @id @default(uuid())
  name          String      @unique
  nameAr        String
  category      FeedCategory
  protein       Float?      // نسبة البروتين %
  energy        Float?      // الطاقة kcal/kg
  unitPrice     Float?
  supplier      String?
  notes         String?     @db.Text
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  stock         FeedStock[]
  schedules     FeedingSchedule[]
  consumptions  DailyFeedConsumption[]

  @@index([category])
}

model FeedStock {
  id          String    @id @default(uuid())
  feedTypeId  String
  feedType    FeedType  @relation(fields: [feedTypeId], references: [id], onDelete: Cascade)
  quantity    Float     // بالكيلوجرام
  unit        String    @default("كجم")
  purchaseDate DateTime
  expiryDate  DateTime?
  cost        Float?
  supplier    String?
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([feedTypeId])
  @@index([expiryDate])
}

model FeedingSchedule {
  id          String    @id @default(uuid())
  feedTypeId  String
  feedType    FeedType  @relation(fields: [feedTypeId], references: [id], onDelete: Cascade)
  penId       String?
  pen         Pen?      @relation(fields: [penId], references: [id], onDelete: SetNull)
  quantity    Float     // الكمية اليومية
  frequency   Int       @default(2)  // عدد المرات باليوم
  startDate   DateTime
  endDate     DateTime?
  isActive    Boolean   @default(true)
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([feedTypeId])
  @@index([penId])
  @@index([isActive])
}

model DailyFeedConsumption {
  id          String    @id @default(uuid())
  date        DateTime  // تاريخ الصرف (يبدأ من بداية اليوم)
  feedTypeId  String
  feedType    FeedType  @relation(fields: [feedTypeId], references: [id], onDelete: Cascade)
  penId       String?   // الحظيرة (اختياري - للتقارير)
  pen         Pen?      @relation(fields: [penId], references: [id], onDelete: SetNull)
  quantity    Float     // الكمية المصروفة بالكيلوجرام
  cost        Float?    // التكلفة (من سعر المخزون)
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([date, feedTypeId, penId]) // منع التكرار لنفس اليوم ونوع العلف والحظيرة
  @@index([date])
  @@index([feedTypeId])
  @@index([penId])
}

model CalendarEvent {
  id          String       @id @default(uuid())
  title       String
  description String?      @db.Text
  eventType   EventType
  date        DateTime
  endDate     DateTime?
  isCompleted Boolean      @default(false)
  goatId      String?
  breedingId  String?
  healthId    String?
  reminder    Boolean      @default(true)
  reminderDays Int?        // تذكير قبل كم يوم
  notes       String?      @db.Text
  createdBy   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([eventType])
  @@index([date])
  @@index([isCompleted])
}

enum InventoryCategory {
  MEDICINE
  VACCINE
  EQUIPMENT
  SUPPLIES
  CLEANING
  OTHER
}

enum TransactionType {
  PURCHASE
  USAGE
  ADJUSTMENT
  EXPIRED
  RETURN
}

enum FeedCategory {
  HAY
  GRAINS
  CONCENTRATE
  SUPPLEMENTS
  MINERALS
  OTHER
}

enum EventType {
  BIRTH
  VACCINATION
  DEWORMING
  CHECKUP
  BREEDING
  WEANING
  SALE
  PURCHASE
  MAINTENANCE
  OTHER
}

model AppSetting {
  id                       String   @id @default("default")
  farmName                 String?
  phone                    String?
  address                  String?
  currency                 String   @default("AED")
  notifications            Boolean  @default(true)
  alertPenCapacityPercent  Int      @default(90)
  alertDeathCount          Int      @default(3)
  alertDeathWindowDays     Int      @default(30)
  alertBreedingOverdueDays Int      @default(150)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
}
