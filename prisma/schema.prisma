generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== SaaS Multi-Tenant ====================

model Tenant {
  id               String    @id @default(uuid())
  name             String
  nameAr           String?
  email            String    @unique
  phone            String?
  plan             Plan      @default(FREE)
  maxFarms         Int       @default(1)
  maxGoats         Int       @default(50)
  maxUsers         Int       @default(2)
  isActive         Boolean   @default(true)
  trialEndsAt      DateTime?
  stripeCustomerId String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  users         User[]
  farms         Farm[]
  subscriptions Subscription[]
}

model Farm {
  id                       String   @id @default(uuid())
  tenantId                 String   @default("")
  tenant                   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name                     String
  nameAr                   String
  phone                    String?
  address                  String?
  currency                 String   @default("AED")
  notifications            Boolean  @default(true)
  alertPenCapacityPercent  Int      @default(90)
  alertDeathCount          Int      @default(3)
  alertDeathWindowDays     Int      @default(30)
  alertBreedingOverdueDays Int      @default(150)
  isActive                 Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  userFarms            UserFarm[]
  pens                 Pen[]
  goats                Goat[]
  healthRecords        HealthRecord[]
  breedings            Breeding[]
  sales                Sale[]
  expenses             Expense[]
  inventoryItems       InventoryItem[]
  feedTypes            FeedType[]
  feedingSchedules     FeedingSchedule[]
  calendarEvents       CalendarEvent[]
  activityLogs         ActivityLog[]
  vaccinationProtocols VaccinationProtocol[]

  @@index([tenantId])
}

model UserFarm {
  id     String   @id @default(uuid())
  userId String
  farmId String   @default("")
  role   UserRole @default(USER)
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  farm   Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@unique([userId, farmId])
  @@index([userId])
  @@index([farmId])
}

model Subscription {
  id            String             @id @default(uuid())
  tenantId      String             @default("")
  tenant        Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan          Plan
  status        SubscriptionStatus @default(ACTIVE)
  startDate     DateTime
  endDate       DateTime?
  amount        Float
  currency      String             @default("AED")
  paymentMethod String?
  stripeSubId   String?
  notes         String?            @db.Text
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([tenantId])
}

enum Plan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  PENDING
  CANCELLED
  EXPIRED
  PAST_DUE
}

// ==================== Users ====================

model User {
  id        String    @id @default(uuid())
  tenantId  String    @default("")
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  username  String    @unique
  email     String    @unique
  password  String
  fullName  String
  phone     String?
  role      UserRole  @default(USER)
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  resetToken       String?
  resetTokenExpiry DateTime?
  emailVerified    Boolean   @default(false)
  verifyToken      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  permissions UserPermission[]
  activities  ActivityLog[]
  userFarms   UserFarm[]

  @@index([tenantId])
  @@index([username])
  @@index([email])
  @@index([role])
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  nameAr      String
  category    String
  categoryAr  String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users UserPermission[]

  @@index([category])
}

model UserPermission {
  id           String     @id @default(uuid())
  userId       String
  permissionId String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  grantedAt    DateTime   @default(now())
  grantedBy    String?

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

// ==================== Activity Log ====================

model ActivityLog {
  id          String   @id @default(uuid())
  tenantId    String   @default("")
  farmId      String?
  farm        Farm?    @relation(fields: [farmId], references: [id], onDelete: SetNull)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action      String
  entity      String
  entityId    String?
  description String   @db.Text
  ipAddress   String?
  userAgent   String?  @db.Text
  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([farmId])
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}

// ==================== Types & Breeds (shared) ====================

model GoatType {
  id          String   @id @default(uuid())
  name        String   @unique
  nameAr      String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  breeds Breed[]

  @@index([name])
}

model Breed {
  id              String   @id @default(uuid())
  typeId          String
  type            GoatType @relation(fields: [typeId], references: [id], onDelete: Cascade)
  name            String
  nameAr          String
  description     String?  @db.Text
  avgWeight       Float?
  avgHeight       Float?
  characteristics String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  goats Goat[]

  @@unique([typeId, name])
  @@index([typeId])
}

// ==================== Pens ====================

model Pen {
  id        String   @id @default(uuid())
  tenantId  String   @default("")
  farmId    String   @default("")
  farm      Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name      String
  nameAr    String
  capacity  Int?
  type      String?
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  goats            Goat[]
  feedingSchedules FeedingSchedule[]
  feedConsumptions DailyFeedConsumption[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([farmId])
}

// ==================== Goats ====================

model Goat {
  id            String     @id @default(uuid())
  tenantId      String     @default("")
  farmId        String     @default("")
  farm          Farm       @relation(fields: [farmId], references: [id], onDelete: Cascade)
  tagId         String
  name          String?
  breedId       String
  breed         Breed      @relation(fields: [breedId], references: [id])
  gender        Gender
  birthDate     DateTime
  weight        Float?
  color         String?
  status        GoatStatus @default(ACTIVE)
  motherId      String?
  fatherId      String?
  motherTagId   String?
  fatherTagId   String?
  birthId       String?
  penId         String?
  purchaseDate  DateTime?
  purchasePrice Float?
  notes         String?    @db.Text
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  pen          Pen?    @relation(fields: [penId], references: [id], onDelete: SetNull)
  mother       Goat?   @relation("GoatMother", fields: [motherId], references: [id], onDelete: SetNull)
  father       Goat?   @relation("GoatFather", fields: [fatherId], references: [id], onDelete: SetNull)
  kidsAsMother Goat[]  @relation("GoatMother")
  kidsAsFather Goat[]  @relation("GoatFather")
  kidBirths    Birth[] @relation("KidGoat")

  healthRecords    HealthRecord[]
  breedingAsMother Breeding[]      @relation("MotherGoat")
  breedingAsFather Breeding[]      @relation("FatherGoat")
  feedingRecords   FeedingRecord[]
  sales            Sale[]

  @@unique([tenantId, tagId])
  @@index([tenantId])
  @@index([farmId])
  @@index([tagId])
  @@index([breedId])
  @@index([status])
  @@index([motherId])
  @@index([fatherId])
  @@index([birthId])
}

// ==================== Health ====================

model HealthRecord {
  id           String     @id @default(uuid())
  tenantId     String     @default("")
  farmId       String     @default("")
  farm         Farm       @relation(fields: [farmId], references: [id], onDelete: Cascade)
  goatId       String
  goat         Goat       @relation(fields: [goatId], references: [id], onDelete: Cascade)
  type         HealthType
  date         DateTime
  description  String     @db.Text
  veterinarian String?
  medication   String?
  dosage       String?
  cost         Float?
  nextDueDate  DateTime?
  notes        String?    @db.Text
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([tenantId])
  @@index([farmId])
  @@index([goatId])
  @@index([type])
  @@index([date])
}

model VaccinationProtocol {
  id           String     @id @default(uuid())
  tenantId     String     @default("")
  farmId       String     @default("")
  farm         Farm       @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name         String
  nameAr       String
  type         HealthType @default(VACCINATION)
  ageMonths    Int
  repeatMonths Int?
  description  String?    @db.Text
  medication   String?
  dosage       String?
  gender       Gender?
  isActive     Boolean    @default(true)
  notes        String?    @db.Text
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([tenantId])
  @@index([farmId])
  @@index([isActive])
  @@index([ageMonths])
}

// ==================== Breeding ====================

model Breeding {
  id              String          @id @default(uuid())
  tenantId        String          @default("")
  farmId          String          @default("")
  farm            Farm            @relation(fields: [farmId], references: [id], onDelete: Cascade)
  motherId        String
  fatherId        String
  mother          Goat            @relation("MotherGoat", fields: [motherId], references: [id])
  father          Goat            @relation("FatherGoat", fields: [fatherId], references: [id])
  matingDate      DateTime
  pregnancyStatus PregnancyStatus @default(MATED)
  dueDate         DateTime?
  birthDate       DateTime?
  numberOfKids    Int?
  notes           String?         @db.Text
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  births Birth[]

  @@index([tenantId])
  @@index([farmId])
  @@index([motherId])
  @@index([fatherId])
  @@index([matingDate])
}

model Birth {
  id         String      @id @default(uuid())
  tenantId   String      @default("")
  breedingId String
  breeding   Breeding    @relation(fields: [breedingId], references: [id], onDelete: Cascade)
  kidTagId   String
  kidGoatId  String?
  kidGoat    Goat?       @relation("KidGoat", fields: [kidGoatId], references: [id], onDelete: SetNull)
  gender     Gender
  weight     Float?
  status     BirthStatus
  notes      String?     @db.Text
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@index([tenantId])
  @@index([breedingId])
  @@index([kidTagId])
  @@index([kidGoatId])
}

// ==================== Feeding ====================

model FeedingRecord {
  id        String   @id @default(uuid())
  tenantId  String   @default("")
  farmId    String   @default("")
  goatId    String?
  goat      Goat?    @relation(fields: [goatId], references: [id], onDelete: SetNull)
  date      DateTime
  feedType  String
  quantity  Float
  unit      String
  cost      Float?
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([farmId])
  @@index([goatId])
  @@index([date])
}

// ==================== Sales ====================

model Sale {
  id            String        @id @default(uuid())
  tenantId      String        @default("")
  farmId        String        @default("")
  farm          Farm          @relation(fields: [farmId], references: [id], onDelete: Cascade)
  goatId        String?
  goat          Goat?         @relation(fields: [goatId], references: [id], onDelete: SetNull)
  date          DateTime
  buyerName     String
  buyerPhone    String?
  salePrice     Float
  paymentStatus PaymentStatus @default(PENDING)
  notes         String?       @db.Text
  payments      Payment[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([tenantId])
  @@index([farmId])
  @@index([goatId])
  @@index([date])
}

model Payment {
  id            String        @id @default(uuid())
  tenantId      String        @default("")
  saleId        String
  sale          Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  amount        Float
  paymentDate   DateTime
  paymentMethod PaymentMethod @default(CASH)
  notes         String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([tenantId])
  @@index([saleId])
  @@index([paymentDate])
}

// ==================== Expenses ====================

model Expense {
  id            String          @id @default(uuid())
  tenantId      String          @default("")
  farmId        String          @default("")
  farm          Farm            @relation(fields: [farmId], references: [id], onDelete: Cascade)
  date          DateTime
  category      ExpenseCategory
  description   String
  amount        Float
  paymentMethod String?
  notes         String?         @db.Text
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([tenantId])
  @@index([farmId])
  @@index([date])
  @@index([category])
}

// ==================== Enums ====================

enum Gender {
  MALE
  FEMALE
}

enum GoatStatus {
  ACTIVE
  SOLD
  DECEASED
  QUARANTINE
}

enum HealthType {
  VACCINATION
  DEWORMING
  TREATMENT
  CHECKUP
  SURGERY
}

enum PregnancyStatus {
  MATED
  PREGNANT
  DELIVERED
  FAILED
}

enum BirthStatus {
  ALIVE
  STILLBORN
  DIED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
}

enum PaymentMethod {
  CASH
  TRANSFER
  CHECK
  OTHER
}

enum ExpenseCategory {
  FEED
  MEDICINE
  VETERINARY
  EQUIPMENT
  LABOR
  UTILITIES
  MAINTENANCE
  OTHER
}

enum UserRole {
  SUPER_ADMIN
  OWNER
  ADMIN
  MANAGER
  VETERINARIAN
  USER
  VIEWER
}

// ==================== Inventory ====================

model InventoryItem {
  id           String            @id @default(uuid())
  tenantId     String            @default("")
  farmId       String            @default("")
  farm         Farm              @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name         String
  nameAr       String
  category     InventoryCategory
  unit         String
  minStock     Float?
  currentStock Float             @default(0)
  unitPrice    Float?
  supplier     String?
  notes        String?           @db.Text
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  transactions InventoryTransaction[]

  @@index([tenantId])
  @@index([farmId])
  @@index([category])
  @@index([currentStock])
}

model InventoryTransaction {
  id        String          @id @default(uuid())
  tenantId  String          @default("")
  itemId    String
  item      InventoryItem   @relation(fields: [itemId], references: [id], onDelete: Cascade)
  type      TransactionType
  quantity  Float
  unitPrice Float?
  totalCost Float?
  reference String?
  notes     String?         @db.Text
  date      DateTime        @default(now())
  createdBy String?
  createdAt DateTime        @default(now())

  @@index([tenantId])
  @@index([itemId])
  @@index([type])
  @@index([date])
}

// ==================== Feed ====================

model FeedType {
  id        String       @id @default(uuid())
  tenantId  String       @default("")
  farmId    String       @default("")
  farm      Farm         @relation(fields: [farmId], references: [id], onDelete: Cascade)
  name      String
  nameAr    String
  category  FeedCategory
  protein   Float?
  energy    Float?
  unitPrice Float?
  supplier  String?
  notes     String?      @db.Text
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  stock        FeedStock[]
  schedules    FeedingSchedule[]
  consumptions DailyFeedConsumption[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([farmId])
  @@index([category])
}

model FeedStock {
  id           String    @id @default(uuid())
  tenantId     String    @default("")
  feedTypeId   String
  feedType     FeedType  @relation(fields: [feedTypeId], references: [id], onDelete: Cascade)
  quantity     Float
  unit         String    @default("كجم")
  purchaseDate DateTime
  expiryDate   DateTime?
  cost         Float?
  supplier     String?
  notes        String?   @db.Text
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([tenantId])
  @@index([feedTypeId])
  @@index([expiryDate])
}

model FeedingSchedule {
  id         String    @id @default(uuid())
  tenantId   String    @default("")
  farmId     String    @default("")
  farm       Farm      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  feedTypeId String
  feedType   FeedType  @relation(fields: [feedTypeId], references: [id], onDelete: Cascade)
  penId      String?
  pen        Pen?      @relation(fields: [penId], references: [id], onDelete: SetNull)
  quantity   Float
  frequency  Int       @default(2)
  startDate  DateTime
  endDate    DateTime?
  isActive   Boolean   @default(true)
  notes      String?   @db.Text
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([tenantId])
  @@index([farmId])
  @@index([feedTypeId])
  @@index([penId])
  @@index([isActive])
}

model DailyFeedConsumption {
  id         String   @id @default(uuid())
  tenantId   String   @default("")
  farmId     String   @default("")
  date       DateTime
  feedTypeId String
  feedType   FeedType @relation(fields: [feedTypeId], references: [id], onDelete: Cascade)
  penId      String?
  pen        Pen?     @relation(fields: [penId], references: [id], onDelete: SetNull)
  quantity   Float
  cost       Float?
  notes      String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([date, feedTypeId, penId])
  @@index([tenantId])
  @@index([farmId])
  @@index([date])
  @@index([feedTypeId])
  @@index([penId])
}

// ==================== Calendar ====================

model CalendarEvent {
  id           String    @id @default(uuid())
  tenantId     String    @default("")
  farmId       String    @default("")
  farm         Farm      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  title        String
  description  String?   @db.Text
  eventType    EventType
  date         DateTime
  endDate      DateTime?
  isCompleted  Boolean   @default(false)
  goatId       String?
  breedingId   String?
  healthId     String?
  reminder     Boolean   @default(true)
  reminderDays Int?
  notes        String?   @db.Text
  createdBy    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([tenantId])
  @@index([farmId])
  @@index([eventType])
  @@index([date])
  @@index([isCompleted])
}

// ==================== More Enums ====================

enum InventoryCategory {
  MEDICINE
  VACCINE
  EQUIPMENT
  SUPPLIES
  CLEANING
  OTHER
}

enum TransactionType {
  PURCHASE
  USAGE
  ADJUSTMENT
  EXPIRED
  RETURN
}

enum FeedCategory {
  HAY
  GRAINS
  CONCENTRATE
  SUPPLEMENTS
  MINERALS
  OTHER
}

enum EventType {
  BIRTH
  VACCINATION
  DEWORMING
  CHECKUP
  BREEDING
  WEANING
  SALE
  PURCHASE
  MAINTENANCE
  OTHER
}

// ==================== App Settings (kept for migration) ====================

model AppSetting {
  id                       String   @id @default("default")
  farmName                 String?
  phone                    String?
  address                  String?
  currency                 String   @default("AED")
  notifications            Boolean  @default(true)
  alertPenCapacityPercent  Int      @default(90)
  alertDeathCount          Int      @default(3)
  alertDeathWindowDays     Int      @default(30)
  alertBreedingOverdueDays Int      @default(150)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
}
